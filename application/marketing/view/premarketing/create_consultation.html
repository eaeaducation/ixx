{extend name="admin@public/content"}

{block name="content"}
<style>
    div#interest {
        height: 34px;
        line-height: 34px;
    }

    div#interest img {
        width: 22px;
        height: auto;
    }
</style>
<form onsubmit="return false;" action="{:request()->url()}"  data-auto="true" method="post"
      class='form-horizontal layui-form padding-top-20'>
    <fieldset class="layui-elem-field layui-field-title">
        <legend>基本信息</legend>
    </fieldset>
    <div data-consultation-type="basic" class="form-item">
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                姓名
            </label>
            <div class='col-sm-4'>
                <input type="text" name="name" required="required"
                       value=""
                       title="请输入客户姓名" placeholder="请输入客户姓名" class="layui-input">
            </div>

            <label class="col-sm-1 control-label">
                性别
            </label>
            <div class='col-sm-4'>
                {:get_category_radio(3, 'gender', 1)}
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                监护人电话
            </label>
            <div class='col-sm-4'>
                <input type="text" name="parent_tel" required="required"
                       value=""
                       title="电话号码必须输入手机号码" placeholder="请输入联系人电话" class="layui-input" pattern="^1\d{10}$">
            </div>
            <label class="col-sm-1 control-label">
                昵称
            </label>
            <div class='col-sm-4'>
                <input type="text" name="nickname" value=""
                       title="请输入昵称" placeholder="请输入昵称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                亲属关系
            </label>
            <div class='col-sm-4'>
                {:get_category_radio(9, 'relation', 1)}
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                出生日期
            </label>
            <div class='col-sm-4'>
                <input type="text" name="birthday"
                       value="" class="layui-input" placeholder="请输入出生日期">
            </div>
            <label class="col-sm-1 control-label">
                QQ号码
            </label>
            <div class='col-sm-4'>
                <input type="text" name="qq"
                       value="" class="layui-input" placeholder="请输入QQ号码">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                监护人姓名
            </label>
            <div class='col-sm-4'>
                <input type="text" name="parent_name" value="" title="请输入联系人姓名" required="required"
                       placeholder="请输入联系人姓名" class="layui-input">
            </div>
            <label class="col-sm-1 control-label">
                微信号码
            </label>
            <div class='col-sm-4'>
                <input type="text" name="wechat"
                       value=""
                       title="请输入微信号码" placeholder="请输入微信号码" class="layui-input">

            </div>
        </div>

        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                标签
            </label>
            <div class='col-sm-9'>
                <input type="text" name="tags"
                       value="" class="layui-input" placeholder="请输入标签">
                <div class="help-block">
                    <p class="text-info">请以半角 <code>,</code> 分隔每个标签</p>
                </div>
                <div class="help-block text-right">
                    <a href="javascript:showMore()">更多信息 >></a>
                </div>
            </div>

        </div>



    </div>
    <div data-consultation-type="other" class="form-item" style="display:none;">
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                公立学校
            </label>
            <div class='col-sm-4'>
                <input type="text" name="school"
                       value="" class="layui-input" placeholder="请输入公立学校">
            </div>
            <label class="col-sm-1 control-label">
                公立班级
            </label>
            <div class='col-sm-4'>
                <input type="text" name="class"
                       value="" class="layui-input" placeholder="请输入公立学校班级">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                居住地址
            </label>
            <div class='col-sm-9'>
                <input type="text" name="address"
                       value="" class="layui-input" placeholder="请输入居住地址">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                其他信息
            </label>
            <div class='col-sm-9'>
                <input type="text" name="other_info"
                       value="" class="layui-input" placeholder="请输入其他信息">
            </div>
        </div>
    </div>

    <fieldset class="layui-elem-field layui-field-title">
        <legend>咨询信息</legend>
    </fieldset>
    <div class="follow">
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                咨询方式
            </label>
            <div class='col-sm-4'>
                {:get_category_radio(4, 'follow[type]', 1)}
            </div>
            <label class="col-sm-1 control-label">
                意向度
            </label>
            <div class='col-sm-4'>
                <div id="interest" data-path="static/plugs/jquery-raty/images"></div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                意向课程
            </label>
            <div class='col-sm-3'>
                {:get_category_select(6, 'follow[interest_course_1]', '', '', [], false)}
            </div>
            <div class='col-sm-3'>
                {:get_category_select(6, 'follow[interest_course_2]', '', '', [], false)}
            </div>
            <div class='col-sm-3'>
                {:get_category_select(6, 'follow[interest_course_3]', '', '', [], false)}
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                沟通内容
            </label>
            <div class='col-sm-9'>
                <textarea name="follow[content]" id="" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                关键词
            </label>
            <div class='col-sm-9'>
                <input id="keywords" type="text" name="follow[keyword]"
                       value="" class="layui-input" placeholder="请以半角 , 分隔每个关键词">
                <div class="help-block">
                    <p class="text-info">
                        {if isset($tips_list)}
                        {$tips_list|raw}
                        {/if}
                    </p>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                跟进状态
            </label>
            <div class='col-sm-4'>
                {:get_category_select(7, 'follow[follow_status]', '', '', ['required'=>'required'])}
            </div>
            <label class="col-sm-1 control-label">
                下次跟进时间
            </label>
            <div class='col-sm-4'>
                <input type="text" name="follow[remind_time]"
                       value="" class="layui-input" required="required">
            </div>
        </div>
    </div>
    <fieldset class="layui-elem-field layui-field-title">
        <legend>经办信息</legend>
    </fieldset>
    <div>
        <div class="layui-form-item">
            <label class="col-sm-1 control-label">
                经办校区
            </label>
            <div class='col-sm-2'>
                {:get_branches_select('branch', session('user.employee.department'), '', ["lay-filter"=>"campus"], false)}
            </div>
            <label class="col-sm-1 control-label">
                来源渠道
            </label>
            <div class='col-sm-2'>
                {:get_channels_select('source', '', '', [], false)}
            </div>
            <label class="col-sm-1 control-label">
                采单员
            </label>
            <div class='col-sm-2' id="sale">
                {:get_employee_select('', 'sales_id', session('user.employee.department'), session('user.id'), '', [], false)}
            </div>
            <label class="col-sm-1 control-label">
               销售员(CC)
            </label>
            <div class='col-sm-2' id="cc">
                {:get_sellers_select('cc','collect_id', '', '', [],false)}
            </div>
        </div>
    </div>
    <div class="hr-line-dashed"></div>
    <input type="hidden" name="created_at" value="{:time()}">
    <input type="hidden" name="follow[created_at]" value="{:time()}">
    <input type="hidden" name="device_info" value="System">
    <div class="col-sm-4 col-sm-offset-3">
        <div class="layui-form-item text-center">
            <button class="layui-btn" type="submit">保存</button>
        </div>
    </div>

</form>
{/block}

{block name="script"}
<script>
    window.form.render();
    window.laydate.render({range: false, elem: 'input[name="birthday"]', max: '{:date("Y-m-d")}'});
    window.laydate.render({
        range: false,
        elem: 'input[name="follow[remind_time]"]',
        value: '{:date("Y-m-d", strtotime("+7 days"))}'
    });

    $(".tipsbtu").click(function(){
        var $this = $(this);
        var clickey = $this.html();
        var keywords = $("#keywords").val();
        var reg_str =  /(^\，*)|(\，*$)/g  ;
        var reg_str2 =  /(^\，*)/;
        if($this.attr("checked")){
            $this.removeAttr("checked");
            $this.removeAttr("style");
            if(keywords.length<1){
                return false;
            }else{
                var keywordarr = keywords.split("，");
                removeByValue(keywordarr,clickey);
                var lt = keywordarr.join("，");
                $("#keywords").val(lt);
            }
        }else{
            if(keywords.length<1){
                var nowkeys = clickey;
            }else{
                var nowkeys = keywords+'，'+clickey;
            }
            $("#keywords").val(nowkeys);
            $this.css("background","#ccc");
            $this.attr("checked","1");
        }
    })

    function removeByValue(arr, val) {
        for(var i=0; i<arr.length; i++) {
            if(arr[i] == val) {
                arr.splice(i, 1);
                break;
            }
        }
    }

    function showMore() {
        $("[data-consultation-type='other']").toggle();
    }

    require(['jquery.raty'], function () {
        $('div#interest').raty({
            number: 5,
            half: true,
            scoreName: 'follow[interest]',
            score: 0,
            path: function () {
                return this.getAttribute('data-path');
            }
        });
    })
    /**
     * 校区二级联动
     */
    form.on('select(campus)', function (data) {
        $('#sale').children().remove();
        $('#cc').children().remove();
        $.post('{:url("$classuri/get_sales")}', {"school": data.value}, function (info) {
            var data = info.data;
            var sale = '<select name="sales_id"><option value="">-请选择-</option>';
            var cc = '<select name="collect_id"><option value="">-请选择-</option>';
            $.each(data, function(key, val){
                if($.inArray(val.authorize, [11,3,5]) != -1){
                    cc += '<option value="' + val.id + '">' + val.name + '</option>option>';
                }
                sale += '<option value="' + val.id + '">' + val.name + '</option>option>';
            })
            sale += '</select>';
            cc += '</select>';
            $('#sale').append(sale);
            $('#cc').append(cc);
            window.form.render();
        })
    })
</script>
{/block}